---
name: Auto-Approve PR (pull_request_target)

# This workflow uses pull_request_target to approve PRs created by github-actions[bot]
# pull_request_target provides higher permissions and can approve self-created PRs

on:
  pull_request_target:
    types: [opened, synchronize, edited, reopened, ready_for_review]
    branches:
      - main

permissions:
  pull-requests: write
  contents: read
  checks: read

jobs:
  approve:
    name: Auto-Approve PR
    runs-on: ubuntu-latest
    # Only approve bot PRs
    # Note: We check branch name and author, not labels, to avoid issues with "autorelease: pending"
    if: |
      (github.event.pull_request.user.login == 'renovate[bot]' ||
       github.event.pull_request.user.login == 'github-actions[bot]' ||
       github.event.pull_request.user.login == 'github-actions' ||
       contains(github.event.pull_request.user.login, 'renovate') ||
       startsWith(github.event.pull_request.head.ref, 'release-please--')) &&
      github.event.pull_request.state == 'open'

    steps:
      - name: Check CI status
        id: check_ci
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });

            console.log('Available checks:');
            checks.check_runs.forEach(check => {
              console.log(`- ${check.name}: ${check.status}/${check.conclusion}`);
            });

            // Check if CI/CD Pipeline or Test Bot PR passed
            const ciCheck = checks.check_runs.find(
              check => check.name === 'CI/CD Pipeline' && check.status === 'completed' && check.conclusion === 'success'
            );

            const testCheck = checks.check_runs.find(
              check => check.name === 'Test Bot PR' && check.status === 'completed' && check.conclusion === 'success'
            );

            const ciPassed = ciCheck !== undefined || testCheck !== undefined;
            core.setOutput('ci_passed', ciPassed);
            console.log(`\nCI/CD Pipeline passed: ${ciPassed}`);

            if (!ciPassed) {
              console.log('⚠️  CI checks not yet passed. This workflow will skip approval.');
            }

      - name: Debug PR info
        run: |
          echo "=== PR Information ==="
          echo "PR author: ${{ github.event.pull_request.user.login }}"
          echo "PR branch: ${{ github.event.pull_request.head.ref }}"
          echo "PR labels: ${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "CI passed: ${{ steps.check_ci.outputs.ci_passed }}"
          echo "======================"

      - name: Approve PR
        if: steps.check_ci.outputs.ci_passed == 'true'
        uses: actions/github-script@v7
        with:
          # Using GITHUB_TOKEN with pull_request_target event has higher permissions
          # This allows the repository to approve PRs created by github-actions[bot]
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;

            console.log(`Attempting to approve PR #${prNumber} created by ${prAuthor}...`);

            try {
              const { data: review } = await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: '✅ Tests passed! Auto-approved by GitHub Actions.'
              });
              console.log(`✅ PR #${prNumber} approved successfully! Review ID: ${review.id}`);
            } catch (error) {
              if (error.status === 422) {
                console.error(`❌ Failed to approve PR: ${error.message}`);
                console.error('This might be due to GitHub restrictions. Error details:', error);
                throw error;
              } else {
                throw error;
              }
            }
